<html>

<head>
    <title>ArtPlayer</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" href="https://rin2401.github.io/anime/image/r3_512.png">
    <link rel="icon" type="image/png" href="https://rin2401.github.io/anime/image/r3_512.png">
    <meta property="og:image" content="https://rin2401.github.io/anime/image/r3.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.5.17/hls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/artplayer@latest/dist/artplayer.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/artplayer-plugin-hls-control@latest/dist/artplayer-plugin-hls-control.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/artplayer-playlist/dist/artplayer-plugin-playlist.min.js"></script> -->
    <script src="artplayer-plugin-playlist.browser.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/artplayer@latest/dist/artplayer.css">
    <style>
        html,
        body {
            margin-left: 0;
            margin-top: 0;
            width: 100vw;
            overflow: hidden;
            background-color: black;
        }

        .art-video-player {
            --art-padding: 0 !important;
        }
    </style>
</head>

<body>
    <div class="artplayer-app"></div>

    <script>
        imageUrl = "/anime/image/r3_512.png"

        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function updateParams(index) {
            const url = new URL(window.location.href);
            url.searchParams.set('e', index);
            window.history.replaceState({}, '', url);
        }
        function createBlobUrl(data, mimeType = "application/vnd.apple.mpegurl") {
            const blob = new Blob([data], { type: mimeType });
            return URL.createObjectURL(blob);
        }

        function createBase64Url(data, mimeType = "application/vnd.apple.mpegurl") {
            return `data:${mimeType};base64,${btoa(data)}`;
        }

        function removeAds(m3u8, url) {
            var baseUrl = url.split("/").slice(0, -1).join("/") + "/"
            m3u8 = m3u8.replace(/#EXT-X-DISCONTINUITY.*#EXT-X-DISCONTINUITY\n/sg, "");

            m3u8 = m3u8.split('\n').map(line => {
                if (line.startsWith('#') || line.trim() === '') {
                    return line;
                }

                if (!line.match(/^https?:\/\//i)) {
                    return baseUrl + line;
                }

                return line;
            }).join('\n');

            return m3u8
        }

        const id = getUrlParameter('id')
        const url = `https://r3fire.firebaseio.com/anime/${id}.json`
        fetch(url).then(response => response.json()).then(setupPlayer)


        function playM3u8(video, url, art) {
            fetch(url)
                .then(response => response.text())
                .then(data => {
                    m3u8 = removeAds(data, url)
                    if (Hls.isSupported()) {
                        if (art.hls) art.hls.destroy();
                        const hls = new Hls();
                        hls.loadSource(createBlobUrl(m3u8));
                        hls.attachMedia(video);
                        art.hls = hls;
                        art.on('destroy', () => hls.destroy());
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = createBase64Url(m3u8);

                    } else {
                        art.notice.show = 'Unsupported playback format: m3u8';
                    }
                })
                .catch(error => {
                    console.error(error);
                });
        }

        function playJson(video, url, art) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    m3u8 = data.m3u8
                    if (Hls.isSupported()) {
                        if (art.hls) art.hls.destroy();
                        const hls = new Hls();
                        hls.loadSource(createBlobUrl(m3u8));
                        hls.attachMedia(video);
                        art.hls = hls;
                        art.on('destroy', () => hls.destroy());
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = createBase64Url(m3u8);

                    } else {
                        art.notice.show = 'Unsupported playback format: m3u8';
                    }
                })
                .catch(error => {
                    console.error(error);
                });
        }

        function setupPlayer(data) {
            var M = {};

            var episodeList = [];

            Object.entries(data).forEach(([id, episode]) => {
                if (!episode) {
                    return
                }

                id = episode.id || id
                M[id] = episodeList.length;
                episodeList.push({
                    id: id,
                    title: episode.title,
                    url: episode.file
                });
            });
            console.log('Episode list:', episodeList);

            var e = String(getUrlParameter('e'));
            var initialIndex = M[e] ?? episodeList.length - 1;

            updateParams(episodeList[initialIndex].id)
            document.title = episodeList[initialIndex].title

            var art = new Artplayer({
                container: '.artplayer-app',
                url: episodeList[initialIndex].url,
                setting: true,
                isLive: false,
                muted: false,
                autoplay: true,
                pip: true,
                // autoSize: true,
                autoMini: true,
                screenshot: false,
                setting: true,
                loop: true,
                flip: true,
                playbackRate: true,
                aspectRatio: true,
                fullscreen: true,
                fullscreenWeb: false,
                subtitleOffset: true,
                miniProgressBar: true,
                mutex: true,
                backdrop: true,
                playsInline: true,
                autoPlayback: true,
                // airplay: true,
                theme: '#23ade5',
                plugins: [
                    // artplayerPluginHlsControl({
                    //     quality: {
                    //         // Show qualitys in control
                    //         control: true,
                    //         // Show qualitys in setting
                    //         setting: true,
                    //         // Get the quality name from level
                    //         getName: (level) => level.height + 'P',
                    //         // I18n
                    //         title: 'Quality',
                    //         auto: 'Auto',
                    //     },
                    //     audio: {
                    //         // Show audios in control
                    //         control: true,
                    //         // Show audios in setting
                    //         setting: true,
                    //         // Get the audio name from track
                    //         getName: (track) => track.name,
                    //         // I18n
                    //         title: 'Audio',
                    //         auto: 'Auto',
                    //     }
                    // }),
                    artplayerPlaylist({
                        rebuildPlayer: false,
                        onchanged: (art, index) => {
                            console.log("Video Change", index)
                            updateParams(episodeList[index].id)
                            document.title = episodeList[index].title
                        },
                        autoNext: true,
                        showText: false,
                        playlist: episodeList,
                    })
                ],
                customType: {
                    m3u8: playM3u8,
                    json: playJson
                },
                thumbnails: {
                    url: imageUrl,
                    number: 60,
                    column: 10,
                    scale: 0.85,
                },
            });
        }
    </script>
</body>

</html>